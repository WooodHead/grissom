version: '2'

services:
  python: &python
    build: .
    image: joanfont/grissom
    links:
      - mongo
    volumes:
      - ".:/code"

  mongo:
    image: library/mongo:3.4.2
    volumes:
      - "/opt/grissom/mongo:/data/db"
    ports:
      - "7777:27017"

  rabbit:
    image: library/rabbitmq:3.6.6-alpine

  celery:
    <<: *python
    links:
      - mongo
      - rabbit
    entrypoint: ["celery"]
    command: ["worker", "-A", "async.celery"]

  scrapy:
    <<: *python
    links:
      - mongo
      - celery
    env_file:
      - .env
    entrypoint: ["scrapy"]